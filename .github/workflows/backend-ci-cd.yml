name: Backend CI/CD

on:
    push:
        branches: [ develop, master ]
        paths:
            - 'backend/**'
    pull_request:
        types: [opened, synchronize, reopened]
        paths:
            - 'backend/**'
jobs:
    deploy:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend
        
        steps:
        -   uses: actions/checkout@v3

        -   name: Copy files via ssh
            uses: appleboy/scp-action@master
            with:
                host: ${{ secrets.AZURE_VM_IP }}
                username: ${{ secrets.AZURE_VM_USERNAME }}
                key: ${{ secrets.AZURE_VM_SSH_KEY }}
                source: "."
                target: "/home/${{ secrets.AZURE_VM_USERNAME }}"
    
        -   name: Execute commands on the server
            uses: appleboy/ssh-action@master
            with:
                host: ${{ secrets.AZURE_VM_IP }}
                username: ${{ secrets.AZURE_VM_USERNAME }}
                key: ${{ secrets.AZURE_VM_SSH_KEY }}
                script: |
                    cd /home/${{ secrets.AZURE_VM_USERNAME }}/backend
                    docker build -t myapp .
                    # Stop and remove existing container if it exists
                    docker stop myapp || true
                    docker rm myapp || true
                    # Run new container
                    docker run -d --name myapp -p 5000:5000 myapp
